# .github/workflows/azure-static-web-apps.yml

name: Azure Static Web Apps - Jekyll Site Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read # ä¿®æ­£1: secretã®èª­ã¿å–ã‚Šã¨ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«ååˆ†

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: ğŸš€ Checkout Repository
        uses: actions/checkout@v4
        with:
          # ä¿®æ­£2: ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ä½¿ç”¨ã®æœ‰ç„¡ãŒä¸æ˜ãªãŸã‚ã€ãƒ†ãƒ¼ãƒãŒã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ãªã„ãªã‚‰ false ã‚’æ¨å¥¨
          submodules: false 

      # 2. Rubyç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: ğŸ’ Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          # ä¿®æ­£3: å®‰å®šæ€§ã‚’é‡è¦–ã—ã€Rubyãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ 3.2 ã«å›ºå®šï¼ˆå®Ÿå‹™ã§ã®ãƒˆãƒ©ãƒ–ãƒ«å›é¿ï¼‰
          ruby-version: '3.2'
          bundler-cache: true

      # 3. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ãƒ“ãƒ«ãƒ‰
      - name: ğŸ“¦ Install Dependencies and Build Jekyll Site
        run: |
          bundle install
          
          # ä¿®æ­£4: ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§ã®ãŸã‚ã« --trace ã‚’è¿½åŠ 
          # è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®éš›ã«è©³ç´°ãªã‚³ãƒ¼ãƒ«ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‡ºåŠ›
          bundle exec jekyll build --trace

      # 4. SWAã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸŒ Build and Deploy to Azure Static Web Apps
        # ä¿®æ­£5: v1ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨ã‚’æ¨å¥¨
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
          
          action: "upload"
          
          # SWAã®è¨­å®šï¼ˆä¿®æ­£6: output_locationã®ç¢ºèªã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šæ¬¡ç¬¬ï¼‰
          app_location: "." 
          output_location: "_site" 
          api_location: ""
          skip_api_build: true
