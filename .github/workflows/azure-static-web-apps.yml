name: Diagnose Jekyll build artifacts

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  diagnose:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: true

      - name: Install Jekyll & Plugins
        run: |
          gem install bundler
          bundle init
          cat > Gemfile <<'GEMFILE'
          source 'https://rubygems.org'
          gem 'jekyll', '~> 4.3'
          gem 'jekyll-seo-tag', '~> 2.8'
          gem 'jekyll-feed', '~> 0.17'
          GEMFILE
          bundle install

      - name: Build Jekyll (production)
        run: bundle exec jekyll build --trace
        env:
          JEKYLL_ENV: production

      # === ここから診断 ===
      - name: Show _config.yml essentials (if present)
        run: |
          if [ -f _config.yml ]; then
            echo "---- _config.yml (excerpt) ----"
            grep -E '^(url|baseurl|include|exclude|encoding):' _config.yml || true
            echo "--------------------------------"
          else
            echo "_config.yml not found"
          fi

      - name: List top of repository
        run: ls -la

      - name: List _site top-level
        run: |
          ls -la _site || (echo "_site missing" && exit 1)
          echo "Count of files under _site:"
          find _site -type f | wc -l

      - name: Tree under _site/images (top two levels)
        run: |
          if [ -d _site/images ]; then
            find _site/images -maxdepth 2 -type d -print
            echo "Sample files in images (first 50):"
            find _site/images -type f | head -n 50
          else
            echo "_site/images directory missing"
          fi

      - name: List sections dir explicitly
        run: |
          if [ -d _site/images/sections ]; then
            ls -la _site/images/sections
          else
            echo "_site/images/sections not found"
          fi

      - name: Case-insensitive search for target illustration
        run: |
          echo "Searching for any file matching '*holding*illustration*' (case-insensitive):"
          find _site -type f -iname '*holding*illustration*' -print || true

      - name: Verify key artifacts (relaxed if needed)
        run: |
          set -e
          test -f _site/index.html || (echo "index.html missing" && exit 1)
          test -f _site/assets/css/styles.css || (echo "CSS missing" && exit 1)
          # 画像は診断中に落ちやすいので、まず存在状況を上の検索結果で確認。
          # 厳密チェックを有効化したい場合は次行のコメントを外す。
          # test -f _site/images/sections/holding-hand-illustration.png || (echo "image missing" && exit 1)

      - name: Show one HTML reference to images (grep)
        run: |
          echo "Grep src references in built HTML for 'holding-hand-illustration':"
          grep -R --line-number --color=never -i 'holding-hand-illustration' _site || true
          echo "Grep src references for '/images/sections/' in built HTML:"
          grep -R --line-number --color=never '/images/sections/' _site || true

      # === SWA へのアップロードは行わない診断専用 ===
